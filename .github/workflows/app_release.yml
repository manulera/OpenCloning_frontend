name: App Release

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name (e.g., opencloning, test-app)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  create_app_release:
    name: Create App Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate app exists
        run: |
          if [ ! -d "apps/${{ inputs.app_name }}" ]; then
            echo "Error: App '${{ inputs.app_name }}' not found in apps/"
            exit 1
          fi

      - name: Read version from package.json
        id: app_version
        run: |
          VERSION=$(node -p "require('./apps/${{ inputs.app_name }}/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION"

      - name: Extract changelog for version
        id: changelog
        run: |
          CHANGELOG_FILE="apps/${{ inputs.app_name }}/CHANGELOG.md"
          VERSION="${{ steps.app_version.outputs.version }}"
          
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "Warning: Changelog file not found at $CHANGELOG_FILE"
            echo "body=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract the changelog section for this version
          # Match the version header (## VERSION) and capture until next version header
          awk -v version="$VERSION" '
            /^## / {
              if (found) exit
              if ($0 ~ version) {
                found = 1
                print
                next
              }
            }
            found {
              if (/^## /) exit
              print
            }
          ' "$CHANGELOG_FILE" > /tmp/changelog_section.txt
          
          # Use multiline output delimiter for GitHub Actions
          {
            echo "body<<CHANGELOG_EOF"
            cat /tmp/changelog_section.txt
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Extracted changelog for version $VERSION"

      - name: Create tag
        run: |
          TAG="${{ inputs.app_name }}-v${{ steps.app_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release ${{ inputs.app_name }} v${{ steps.app_version.outputs.version }}"
          git push origin "$TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.app_name }}-v${{ steps.app_version.outputs.version }}
          release_name: Release ${{ inputs.app_name }} v${{ steps.app_version.outputs.version }}
          body: ${{ steps.changelog.outputs.body }}
          draft: false
          prerelease: false
