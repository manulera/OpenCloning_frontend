name: Changeset Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-changeset:
    name: Check for Changeset
    runs-on: ubuntu-latest
    # Only check PRs targeting master branch
    # Skip check for version PRs and other automated PRs
    if: |
      github.event.pull_request.base.ref == 'master' &&
      !contains(github.event.pull_request.title, 'Version Packages') &&
      !contains(github.event.pull_request.title, 'chore: version packages')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Checkout the PR branch
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Fetch master branch
        run: |
          # Fetch master so changeset can find where HEAD diverged
          git fetch origin master:master

      - name: Check changeset status
        id: changeset-status
        continue-on-error: true
        run: |
          # Run changeset status comparing against master
          # Exit code 1 means no changesets, but we continue anyway
          STATUS_OUTPUT=$(npx @changesets/cli status --since=master 2>&1) || STATUS_CODE=$?
          
          # Store the output for the comment
          {
            echo 'status_output<<EOF'
            echo "$STATUS_OUTPUT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          # Check if changesets exist (exit code 0 = has changesets, 1 = no changesets)
          if [ "${STATUS_CODE:-0}" -eq 0 ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const hasChangesets = '${{ steps.changeset-status.outputs.has_changesets }}' === 'true';
            const statusOutput = `${{ steps.changeset-status.outputs.status_output }}`;
            
            const comment = hasChangesets
              ? `## ✅ Changeset Status\n\n\`\`\`\n${statusOutput}\n\`\`\`\n\nThis PR includes changesets and is ready for review.`
              : `## ⚠️ Missing Changeset\n\n\`\`\`\n${statusOutput}\n\`\`\`\n\n**Please add a changeset to this PR.**\n\nYou can add one by running:\n\`\`\`bash\nyarn changeset\n\`\`\`\n\nThis helps us track changes and generate changelogs. If this PR doesn't require a version bump (e.g., docs-only), you can add an empty changeset with \`yarn changeset --empty\`.`;
            
            // Find existing comment from this bot
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Changeset Status')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
